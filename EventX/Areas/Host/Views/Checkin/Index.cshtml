@model List<EventX.Models.IssuedTicket>

@{
    ViewData["Title"] = "Check-in vé thủ công";
    var eventId = ViewBag.EventId;
    Layout = "~/Areas/Host/Views/Shared/_HostLayout.cshtml";
}

<!-- Thêm Bootstrap 5 CSS nếu chưa có trong layout -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />

<div class="container my-4">
    <h2 class="mb-4 text-primary fw-bold">Check-in vé thủ công - Sự kiện #@eventId</h2>

    <div class="input-group mb-4" style="max-width: 600px;">
        <input type="text" id="manual-ticket-code" class="form-control rounded-start" placeholder="Nhập mã vé cần check-in" />
        <button id="btn-manual-checkin" class="btn btn-primary">Check-in</button>
        <a href="@Url.Action("QR", "Checkin", new { eventId = eventId })" class="btn btn-secondary rounded-end ms-2">
            QR CHECK IN
        </a>
    </div>


    <div class="table-responsive">
        <table class="table table-striped table-bordered align-middle">
            <thead class="table-dark text-center">
                <tr>
                    <th>Mã vé</th>
                    <th>Tên khách hàng</th>
                    <th>Email</th>
                    <th>Phone</th>
                    <th>Trạng thái</th>
                    <th>Thời gian check-in</th>
                    <th>check-in</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var ticket in Model)
                {
                    <tr>
                        <td class="text-center fw-semibold">@ticket.TicketCode</td>
                        <td>@ticket.OrderDetail?.Order.FullName</td>
                        <td>@ticket.OrderDetail?.Order.Email </td>
                        <td>@ticket.OrderDetail?.Order.PhoneNumber </td>
                        <td class="text-center fs-5">@ticket.OrderDetail?.Order.OrderStatus</td>
                        <td class="text-center">@ticket.CheckinTime?.ToString("dd/MM/yyyy HH:mm:ss")</td>
                        <td class="text-center">
                            @if (!ticket.IsCheckedIn)
                            {
                                <button class="btn btn-success btn-sm btn-checkin" data-ticket-code="@ticket.TicketCode" title="Check-in vé này">
                                    Check-in
                                </button>
                            }
                            else
                            {
                                <span class="text-muted fst-italic">Đã check-in</span>
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script>
        // Check-in theo mã vé nhập tay
        $('#btn-manual-checkin').click(function () {
            var ticketCode = $('#manual-ticket-code').val().trim();
            if (!ticketCode) {
                Swal.fire('Lỗi', 'Vui lòng nhập mã vé', 'warning');
                return;
            }
            manualCheckin(ticketCode);
        });

        // Check-in theo nút bên từng vé
        $('.btn-checkin').click(function () {
            var ticketCode = $(this).data('ticket-code');
            manualCheckin(ticketCode);
        });

        function manualCheckin(ticketCode) {
            $.ajax({
                url: '@Url.Action("ManualCheckIn", "Checkin", new { area = "Host" })',
                type: 'POST',
                data: { ticketCode: ticketCode },
                success: function (res) {
                    if (res.success) {
                        Swal.fire('Thành công', res.message + '\nThời gian: ' + res.checkInTime, 'success')
                            .then(() => location.reload());
                    } else {
                        Swal.fire('Thất bại', res.message, 'error');
                    }
                },
                error: function () {
                    Swal.fire('Lỗi', 'Có lỗi xảy ra khi check-in', 'error');
                }
            });
        }
    </script>
}
